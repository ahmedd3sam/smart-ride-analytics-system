[2025-11-27T09:06:58.390+0000] {taskinstance.py:1157} INFO - Dependencies all met for dep_context=non-requeueable deps ti=<TaskInstance: taxi_streaming_pipeline.start_kafka_producer manual__2025-11-27T09:06:14.328918+00:00 [queued]>
[2025-11-27T09:06:58.397+0000] {taskinstance.py:1157} INFO - Dependencies all met for dep_context=requeueable deps ti=<TaskInstance: taxi_streaming_pipeline.start_kafka_producer manual__2025-11-27T09:06:14.328918+00:00 [queued]>
[2025-11-27T09:06:58.398+0000] {taskinstance.py:1359} INFO - Starting attempt 2 of 2
[2025-11-27T09:06:58.410+0000] {taskinstance.py:1380} INFO - Executing <Task(BashOperator): start_kafka_producer> on 2025-11-27 09:06:14.328918+00:00
[2025-11-27T09:06:58.414+0000] {standard_task_runner.py:57} INFO - Started process 437 to run task
[2025-11-27T09:06:58.419+0000] {standard_task_runner.py:84} INFO - Running: ['airflow', 'tasks', 'run', 'taxi_streaming_pipeline', 'start_kafka_producer', 'manual__2025-11-27T09:06:14.328918+00:00', '--job-id', '100', '--raw', '--subdir', 'DAGS_FOLDER/taxi_pipeline_dag.py', '--cfg-path', '/tmp/tmpnyy9cpm0']
[2025-11-27T09:06:58.420+0000] {standard_task_runner.py:85} INFO - Job 100: Subtask start_kafka_producer
[2025-11-27T09:06:58.477+0000] {task_command.py:415} INFO - Running <TaskInstance: taxi_streaming_pipeline.start_kafka_producer manual__2025-11-27T09:06:14.328918+00:00 [running]> on host 485e0d4eae03
[2025-11-27T09:06:58.576+0000] {taskinstance.py:1660} INFO - Exporting env vars: AIRFLOW_CTX_DAG_OWNER='Menna' AIRFLOW_CTX_DAG_ID='taxi_streaming_pipeline' AIRFLOW_CTX_TASK_ID='start_kafka_producer' AIRFLOW_CTX_EXECUTION_DATE='2025-11-27T09:06:14.328918+00:00' AIRFLOW_CTX_TRY_NUMBER='2' AIRFLOW_CTX_DAG_RUN_ID='manual__2025-11-27T09:06:14.328918+00:00'
[2025-11-27T09:06:58.577+0000] {subprocess.py:63} INFO - Tmp dir root location: /tmp
[2025-11-27T09:06:58.578+0000] {subprocess.py:75} INFO - Running command: ['/bin/bash', '-c', '\n        set -e  # Exit on error\n        set -o pipefail  # Exit on pipe errors\n        \n        echo "=========================================="\n        echo "Starting S3 to Kafka Producer"\n        echo "=========================================="\n        \n        # Check if docker command is available and has socket access\n        DOCKER_AVAILABLE=0\n        if command -v docker &> /dev/null; then\n            echo "Checking Docker access..."\n            if docker ps &> /dev/null 2>&1; then\n                DOCKER_AVAILABLE=1\n                echo "✓ Docker is available and accessible"\n                docker --version\n            else\n                echo "✗ Docker command exists but socket is not accessible"\n                echo "Error details:"\n                docker ps 2>&1 | head -5 || true\n            fi\n        else\n            echo "✗ Docker command not found"\n        fi\n        \n        if [ "$DOCKER_AVAILABLE" != "1" ]; then\n            echo ""\n            echo "ERROR: Docker is not available. Cannot run producer container."\n            echo "Please ensure Docker socket is mounted and accessible."\n            exit 1\n        fi\n        \n        # Check if Kafka is ready (producer depends on it)\n        echo ""\n        echo "Checking if Kafka is ready..."\n        KAFKA_READY=0\n        if docker ps --filter "name=^kafka$" -q | grep -q .; then\n            echo "✓ Kafka container is running"\n            KAFKA_READY=1\n        else\n            echo "✗ Kafka container is not running"\n            echo "Please ensure Kafka is started: docker-compose up -d kafka"\n            exit 1\n        fi\n        \n        # Find docker-compose.yml directory or use Docker directly\n        echo ""\n        echo "Locating docker-compose.yml or preparing to use Docker directly..."\n        COMPOSE_DIR=""\n        USE_DIRECT_DOCKER=0\n        \n        # Try multiple paths to find docker-compose.yml\n        for dir in "/opt/airflow/dags/.." "/opt/airflow" "/root/s3-kafka-flink-pipeline" "$HOME/s3-kafka-flink-pipeline" "/home/menna/s3-kafka-flink-pipeline"; do\n            if [ -f "$dir/docker-compose.yml" ] 2>/dev/null; then\n                COMPOSE_DIR="$dir"\n                echo "✓ Found docker-compose.yml at: $COMPOSE_DIR"\n                break\n            fi\n        done\n        \n        # If not found, try using find\n        if [ -z "$COMPOSE_DIR" ]; then\n            FOUND_PATH=$(find /opt/airflow /root /home -maxdepth 5 -name "docker-compose.yml" -type f 2>/dev/null | grep -v node_modules | head -1)\n            if [ -n "$FOUND_PATH" ]; then\n                COMPOSE_DIR=$(dirname "$FOUND_PATH")\n                echo "✓ Found docker-compose.yml at: $COMPOSE_DIR (via find)"\n            fi\n        fi\n        \n        # If still not found, we\'ll use Docker directly instead of docker-compose\n        if [ -z "$COMPOSE_DIR" ]; then\n            echo "⚠ docker-compose.yml not found, will use Docker commands directly"\n            USE_DIRECT_DOCKER=1\n        fi\n        \n        # Check container status\n        echo ""\n        echo "Checking s3-producer container status..."\n        CONTAINER_EXISTS=$(docker ps -a --filter "name=^s3-producer$" -q | wc -l)\n        CONTAINER_RUNNING=$(docker ps --filter "name=^s3-producer$" -q | wc -l)\n        \n        if [ "$CONTAINER_RUNNING" = "1" ]; then\n            echo "Container is already running. Waiting for it to complete..."\n            EXIT_CODE=$(docker wait s3-producer)\n            echo "Container completed with exit code: $EXIT_CODE"\n        else\n            # Remove old container if it exists (stopped/exited)\n            if [ "$CONTAINER_EXISTS" = "1" ]; then\n                echo "Removing old s3-producer container..."\n                docker rm s3-producer 2>/dev/null || true\n            fi\n            \n            # Create and start fresh container\n            echo ""\n            echo "Creating and starting fresh s3-producer container..."\n            \n            if [ "$USE_DIRECT_DOCKER" = "1" ]; then\n                # Use Docker directly - find the network name from existing containers\n                echo "Using Docker directly (docker-compose.yml not found)..."\n                # Get network name without using format (to avoid Jinja2 issues)\n                KAFKA_INFO=$(docker inspect kafka 2>/dev/null)\n                if [ -n "$KAFKA_INFO" ]; then\n                    NETWORK_NAME=$(echo "$KAFKA_INFO" | grep -A 10 "Networks" | grep -o \'"[^"]*":\' | head -1 | tr -d \'":\')\n                fi\n                if [ -z "$NETWORK_NAME" ]; then\n                    NETWORK_NAME="bridge"\n                fi\n                echo "Using network: $NETWORK_NAME"\n                \n                # Start container with docker run\n                docker run -d                     --name s3-producer                     --network "$NETWORK_NAME"                     -e KAFKA_BROKER=kafka:9092                     -e TOPIC=s3-taxi-trips                     s3-kafka-flink-pipeline-s3-producer:latest 2>/dev/null ||                 docker run -d                     --name s3-producer                     --network "$NETWORK_NAME"                     -e KAFKA_BROKER=kafka:9092                     -e TOPIC=s3-taxi-trips                     s3-producer:latest 2>/dev/null || {\n                    echo "✗ Failed to start container. Image may not exist."\n                    echo "Please ensure s3-producer image is built: docker-compose build s3-producer"\n                    exit 1\n                }\n                echo "✓ Container started successfully with docker run"\n            else\n                # Use docker-compose\n                cd "$COMPOSE_DIR"\n                \n                if ! command -v docker-compose &> /dev/null; then\n                    echo "Trying \'docker compose\' (newer syntax)..."\n                    if command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then\n                        COMPOSE_CMD="docker compose"\n                    else\n                        echo "✗ Neither \'docker-compose\' nor \'docker compose\' available"\n                        exit 1\n                    fi\n                else\n                    COMPOSE_CMD="docker-compose"\n                fi\n                \n                echo "Using: $COMPOSE_CMD"\n                echo "Starting container..."\n                \n                # Start the container\n                if $COMPOSE_CMD up -d s3-producer; then\n                    echo "✓ Container started successfully"\n                else\n                    EXIT_CODE=$?\n                    echo "✗ Failed to start container (exit code: $EXIT_CODE)"\n                    echo "Checking container logs..."\n                    docker logs s3-producer 2>&1 | tail -20 || true\n                    exit $EXIT_CODE\n                fi\n            fi\n            \n            # Wait a moment for container to initialize\n            echo "Waiting for container to initialize..."\n            sleep 3\n            \n            # Check if container is still running (it might exit quickly)\n            if docker ps --filter "name=^s3-producer$" -q | grep -q .; then\n                echo "Container is running. Waiting for script to complete..."\n                EXIT_CODE=$(docker wait s3-producer)\n                echo "Container exited with code: $EXIT_CODE"\n            else\n                # Container already exited, get exit code using a method that avoids Jinja2 issues\n                # Use docker inspect without format, then parse JSON with grep/sed\n                CONTAINER_INFO=$(docker inspect s3-producer 2>/dev/null)\n                if [ -n "$CONTAINER_INFO" ]; then\n                    # Extract exit code from JSON using grep and sed (avoids Jinja2 template syntax)\n                    EXIT_CODE=$(echo "$CONTAINER_INFO" | grep -o \'"ExitCode":[0-9]*\' | grep -o \'[0-9]*\' | head -1)\n                    if [ -z "$EXIT_CODE" ]; then\n                        EXIT_CODE=1  # Default to error if can\'t determine\n                    fi\n                else\n                    EXIT_CODE=1  # Container doesn\'t exist, assume error\n                fi\n                echo "Container already exited with code: $EXIT_CODE"\n            fi\n        fi\n        \n        # Check exit code and show logs if failed\n        echo ""\n        if [ "$EXIT_CODE" != "0" ]; then\n            echo "=========================================="\n            echo "ERROR: Producer failed with exit code $EXIT_CODE"\n            echo "=========================================="\n            echo ""\n            echo "Container logs:"\n            echo "----------------------------------------"\n            docker logs s3-producer 2>&1 | tail -50\n            echo "----------------------------------------"\n            echo ""\n            echo "Troubleshooting:"\n            echo "1. Check if S3 credentials are correct"\n            echo "2. Verify S3 bucket and file exist"\n            echo "3. Check if Kafka is accessible from producer container"\n            echo "4. View full logs: docker logs s3-producer"\n            exit $EXIT_CODE\n        else\n            echo "=========================================="\n            echo "✓ Producer completed successfully!"\n            echo "=========================================="\n            echo ""\n            echo "Container logs (last 20 lines):"\n            echo "----------------------------------------"\n            docker logs s3-producer 2>&1 | tail -20\n            echo "----------------------------------------"\n            echo ""\n            echo "Data has been sent to Kafka topic: s3-taxi-trips"\n        fi\n        ']
[2025-11-27T09:06:58.586+0000] {subprocess.py:86} INFO - Output:
[2025-11-27T09:06:58.589+0000] {subprocess.py:93} INFO - ==========================================
[2025-11-27T09:06:58.589+0000] {subprocess.py:93} INFO - Starting S3 to Kafka Producer
[2025-11-27T09:06:58.589+0000] {subprocess.py:93} INFO - ==========================================
[2025-11-27T09:06:58.589+0000] {subprocess.py:93} INFO - Checking Docker access...
[2025-11-27T09:06:58.657+0000] {subprocess.py:93} INFO - ✓ Docker is available and accessible
[2025-11-27T09:06:58.670+0000] {subprocess.py:93} INFO - Docker version 29.0.4, build 3247a5a
[2025-11-27T09:06:58.673+0000] {subprocess.py:93} INFO - 
[2025-11-27T09:06:58.673+0000] {subprocess.py:93} INFO - Checking if Kafka is ready...
[2025-11-27T09:06:58.710+0000] {subprocess.py:93} INFO - ✓ Kafka container is running
[2025-11-27T09:06:58.710+0000] {subprocess.py:93} INFO - 
[2025-11-27T09:06:58.711+0000] {subprocess.py:93} INFO - Locating docker-compose.yml or preparing to use Docker directly...
[2025-11-27T09:06:58.715+0000] {subprocess.py:97} INFO - Command exited with return code 1
[2025-11-27T09:06:58.730+0000] {taskinstance.py:1935} ERROR - Task failed with exception
Traceback (most recent call last):
  File "/home/airflow/.local/lib/python3.8/site-packages/airflow/operators/bash.py", line 210, in execute
    raise AirflowException(
airflow.exceptions.AirflowException: Bash command failed. The command returned a non-zero exit code 1.
[2025-11-27T09:06:58.733+0000] {taskinstance.py:1398} INFO - Marking task as FAILED. dag_id=taxi_streaming_pipeline, task_id=start_kafka_producer, execution_date=20251127T090614, start_date=20251127T090658, end_date=20251127T090658
[2025-11-27T09:06:58.749+0000] {standard_task_runner.py:104} ERROR - Failed to execute job 100 for task start_kafka_producer (Bash command failed. The command returned a non-zero exit code 1.; 437)
[2025-11-27T09:06:58.792+0000] {local_task_job_runner.py:228} INFO - Task exited with return code 1
[2025-11-27T09:06:58.817+0000] {taskinstance.py:2776} INFO - 0 downstream tasks scheduled from follow-on schedule check
